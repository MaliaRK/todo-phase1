# Data Model: Phase III AI-Powered Todo Chatbot

**Feature**: AI-Powered Todo Chatbot
**Branch**: 001-ai-chatbot
**Created**: 2026-01-12

## Entity: Conversation

### Fields
- **id** (Integer, Primary Key, Auto-increment)
  - Unique identifier for each conversation
  - Auto-generated by the database

- **user_id** (Integer, Foreign Key)
  - Links the conversation to a specific user
  - References the user identifier from Better Auth
  - Required field for user isolation

- **created_at** (DateTime, Not Null)
  - Timestamp when the conversation was initiated
  - Automatically set to current timestamp on creation

- **updated_at** (DateTime, Not Null)
  - Timestamp of the last activity in the conversation
  - Updated whenever a new message is added

### Relationships
- One Conversation has Many Messages (One-to-Many)
- Belongs to One User (Many-to-One)

### Validation Rules
- user_id must exist in the users table (foreign key constraint)
- created_at and updated_at are automatically managed by the system
- A user cannot access conversations belonging to other users

---

## Entity: Message

### Fields
- **id** (Integer, Primary Key, Auto-increment)
  - Unique identifier for each message

- **conversation_id** (Integer, Foreign Key)
  - Links the message to its parent conversation
  - Required field to maintain conversation context

- **user_id** (Integer, Foreign Key)
  - Replicates the user_id for quick filtering and validation
  - Ensures message ownership aligns with conversation ownership

- **role** (String, Enum: 'user'|'assistant', Not Null)
  - Defines who sent the message
  - 'user' for messages from the user
  - 'assistant' for messages from the AI agent

- **content** (Text, Not Null)
  - The actual text content of the message
  - Can be the user's natural language input or AI response

- **created_at** (DateTime, Not Null)
  - Timestamp when the message was created
  - Automatically set to current timestamp on creation

### Relationships
- Belongs to One Conversation (Many-to-One)
- Belongs to One User (Many-to-One)

### Validation Rules
- conversation_id must exist in the conversations table
- role must be either 'user' or 'assistant'
- content must not be empty
- user_id must match the conversation's user_id for consistency

---

## Entity: Task (Existing from Phase II)

### Fields (Preserved from Phase II)
- **id** (Integer, Primary Key, Auto-increment)
  - Unique identifier for each task

- **user_id** (Integer, Foreign Key)
  - Links the task to a specific user
  - References the user identifier from Better Auth

- **title** (String, Not Null)
  - Brief description of the task

- **description** (Text, Optional)
  - Detailed description of the task

- **completed** (Boolean, Default: False)
  - Status indicating if the task is completed

- **created_at** (DateTime, Not Null)
  - Timestamp when the task was created

- **updated_at** (DateTime, Not Null)
  - Timestamp when the task was last updated

### Relationships
- Belongs to One User (Many-to-One)
- Referenced by Messages (through AI agent interactions)

### Validation Rules
- user_id must exist in the users table
- title must not be empty
- A user cannot access tasks belonging to other users

---

## Database Schema Relationships

```
User (Better Auth) ──◄──│
                        │
                        ├── Conversation ──◄── Message
                        │
                        └── Task
```

### Key Relationships Explained
1. **User ↔ Conversation**: One user can have multiple conversations
2. **Conversation ↔ Message**: One conversation contains multiple messages
3. **User ↔ Task**: One user can have multiple tasks

### Database Indexes
- Index on `conversations.user_id` for efficient user-based queries
- Index on `messages.conversation_id` for efficient conversation retrieval
- Index on `messages.user_id` for additional user-based filtering
- Composite index on `(conversations.user_id, conversations.id)` for combined queries

### Constraints
- Foreign key constraints ensure referential integrity
- Check constraints ensure role field contains valid values ('user' or 'assistant')
- Unique constraints prevent duplicate relationships where inappropriate

---

## State Transitions

### Task State Transitions
- **Pending → Completed**: When a user marks a task as complete
- **Completed → Pending**: When a user reopens a completed task

### Message Flow
- **Incoming**: User message is stored with role='user'
- **Processing**: AI agent processes the message and determines appropriate actions
- **Outgoing**: AI response is stored with role='assistant'

---

## Data Access Patterns

### Common Queries
1. **Get conversation history**: Retrieve all messages for a specific conversation
2. **User's conversations**: List all conversations for a specific user
3. **Active tasks**: Retrieve pending tasks for a specific user
4. **Task operations**: Create, update, or delete tasks based on AI agent decisions

### Performance Considerations
- Limit conversation history to recent messages for performance
- Implement pagination for long conversations
- Cache frequently accessed user data where appropriate
- Optimize queries with proper indexing